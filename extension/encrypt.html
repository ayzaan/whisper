<html>
  <head>
  </head>
  <body>
    <script src="aes.js" type="text/javascript"></script>
    <script type='text/javascript'>    //prefix and suffix
    //generate random string
    var key = CryptoJS.lib.WordArray.random(128/8).toString();
    var group_id = CryptoJS.lib.WordArray.random(11).toString();
    
    encrypted = CryptoJS.AES.encrypt("Message", key);
    encryptedOutput = "=#Whisper-" + group_id + "-" + encrypted.toString() + "Whisper#=";

    function decrypt() {
	  $('body').html( $('body').html().replace(/=#Whisper-([0-9]{11})(.*)Whisper#=/gm,decrypt_msg('$1', '$2') );
    }

	function decrypt_msg(group_id, msg){
		chrome.storage.local.get(["keys"], function(data)
		{
			if (data.username == null) return "You must login to view this encrypted message";
			else
			{
				keys = JSON.parse(data.keys);
				for(i=0;i<keys.Maths.length;i++){
					key = keys[i].key;
					if (group_id == keys[i].group_id){
						return CryptoJS.AES.decrypt(msg, key);
					}
				}
			}
		});
</script>

  </body>
</html>
